services:
  backend:
    image: 178.18.246.166:5000/mvoice-backend:latest
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "5010:8080"
      - "5011:8081"
    environment:
      - PORT=8080
      - WS_PORT=8081
      - STUN_SERVER=stun:stun.l.google.com:19302
      - TURN_SERVER=turn:coturn:3478
      - TURN_USERNAME=myuser
      - TURN_PASSWORD=mypassword
    networks:
      - m-voice-net
    restart: unless-stopped

  frontend:
    image: 178.18.246.166:5000/mvoice-frontend:latest
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "5012:80"
    depends_on:
      - backend
    networks:
      - m-voice-net
    restart: unless-stopped

  coturn:
    image: coturn/coturn:latest
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
      - "49152-65535:49152-65535/udp"
    environment:
      - DETECT_EXTERNAL_IP=yes
      - DETECT_RELAY_IP=yes
      - LISTENING_PORT=3478
      - MIN_PORT=49152
      - MAX_PORT=65535
      - REALM=m-voice.local
      - USERNAME=myuser
      - PASSWORD=mypassword
    networks:
      - m-voice-net
    restart: unless-stopped
    command:
      - "-n"
      - "--log-file=stdout"
      - "--external-ip=$$(detect-external-ip)"
      - "--listening-port=3478"
      - "--min-port=49152"
      - "--max-port=65535"
      - "--fingerprint"
      - "--lt-cred-mech"
      - "--realm=m-voice.local"
      - "--user=myuser:mypassword"

networks:
  m-voice-net:
    driver: bridge

